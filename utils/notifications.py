"""notifications.pyResponsible for sending status notifications to the notification service.This module replaces notify.sh and must:- Read configuration from environment variables- Build a standard JSON payload- Send notifications via HTTP POST- Never crash the caller (best-effort delivery)Environment variables required:- NOTIFY_URL- SERVER_NAME"""import osimport jsonimport timeimport loggingfrom typing import Optionalimport requestsREQUIRED_ENV_VARS = [    "NOTIFY_URL",    "SERVER_NAME",]SPECIAL_STATUSES = {"PASSWORD_EXPIRED", "LOGIN_ERROR"}def _get_env(var_name: str) -> Optional[str]:    """    Read an environment variable safely.    Args:        var_name (str): Environment variable name    Returns:        Optional[str]: Value or None if missing    """    value = os.getenv(var_name)    if value:        return value.strip()    return Nonedef _validate_env() -> bool:    """    Validate that all required environment variables exist.    Returns:        bool: True if valid, False otherwise    """    missing = [v for v in REQUIRED_ENV_VARS if not _get_env(v)]    if missing:        logging.warning(            "Notification skipped. Missing env vars: %s", ", ".join(missing)        )        return False    return Truedef _build_payload(    report: str,    status: str,    message: str = "",) -> dict:    """    Build the notification JSON payload.    Args:        report (str): Report name        status (str): Status (SUCCESS, FAIL, PASSWORD_EXPIRED, etc.)        message (str): Optional error message    Returns:        dict: JSON payload    """    safe_message = message.strip().splitlines()[-2:] if message else []    extra = f"`{' '.join(safe_message)}`" if safe_message else ""    return {        "report": report.upper(),        "status": status.upper(),        "source_server": _get_env("SERVER_NAME"),        "extra": extra,    }def send_notification(    report: str,    status: str,    message: str = "",    timeout: int = 5,) -> None:    """    Send a notification to the configured notification service.    This function is best-effort:    - It must never raise an exception    - Failures are logged but ignored    Args:        report (str): Report name        status (str): Status string        message (str, optional): Extra message        timeout (int): HTTP timeout in seconds    """    try:        if not _validate_env():            return        payload = _build_payload(report, status, message)        response = requests.post(            _get_env("NOTIFY_URL"),            headers={"Content-Type": "application/json"},            data=json.dumps(payload),            timeout=timeout,        )        if response.status_code >= 400:            logging.warning(                "Notification failed (%s): %s",                response.status_code,                response.text,            )        else:            logging.info(                "Notification sent: %s / %s",                payload["report"],                payload["status"],            )    except Exception as exc:        logging.exception("Notification error (ignored): %s", exc)