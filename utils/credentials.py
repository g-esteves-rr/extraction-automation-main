"""credentials.pyManages credential rotation and state.Responsibilities:- Load credentials ordered by priority- Mark credentials as expired- Update extraction status- Recalculate priorities when state changesThis module NEVER removes fields.It only updates:- priority- status- state- last_used- status_changed_at"""import jsonimport osimport timefrom datetime import datetimefrom typing import List, DictEXPIRED_PRIORITY = 9999# ======================# Public API# ======================def load_credentials(path: str) -> List[Dict]:    """    Load credentials and return accounts ordered by priority.    Input:        path (str): Path to credentials.json    Output:        List[Dict]: Accounts ordered by priority (ascending)    """    data = _load(path)    accounts = data.get("accounts", [])    return sorted(        accounts,        key=lambda a: int(a.get("priority", EXPIRED_PRIORITY))    )def mark_expired(path: str, username: str) -> None:    """    Mark an account as expired and push it to the end.    Input:        path (str)        username (str)    Output:        None    """    data = _load(path)    acc = _find(data, username)    now = _now()    acc["state"] = "expired"    acc["status"] = "expired"    acc["priority"] = EXPIRED_PRIORITY    acc["last_used"] = now    acc["status_changed_at"] = now    _reorder(data["accounts"])    _save(path, data)def update_status(path: str, username: str, status: str) -> None:    """    Update extraction status for a user.    Input:        path (str)        username (str)        status (str): e.g. SUCCESS, FAILED    Output:        None    """    data = _load(path)    acc = _find(data, username)    acc["status"] = status    acc["last_used"] = _now()    _save(path, data)def promote_valid_accounts(path: str) -> None:    """    Promote valid accounts and demote expired ones.    Input:        path (str)    Output:        None    """    data = _load(path)    _reorder(data["accounts"])    _save(path, data)# ======================# Internal helpers# ======================def _now() -> str:    """Return UTC timestamp in ISO-8601 format."""    return datetime.utcnow().isoformat() + "Z"def _load(path: str) -> Dict:    if not os.path.isfile(path):        raise FileNotFoundError(path)    with open(path, "r") as f:        return json.load(f)def _save(path: str, data: Dict) -> None:    tmp = f"{path}.tmp"    with open(tmp, "w") as f:        json.dump(data, f, indent=2, ensure_ascii=False)    os.replace(tmp, path)def _find(data: Dict, username: str) -> Dict:    for acc in data.get("accounts", []):        if acc.get("username") == username:            return acc    raise ValueError(f"User not found: {username}")def _reorder(accounts: List[Dict]) -> None:    """    Recalculate priorities.    Rules:    - Valid users get priorities 1..N    - Expired users always get priority 9999    - Existing relative order is preserved where possible    """    valid = [a for a in accounts if a.get("state") != "expired"]    expired = [a for a in accounts if a.get("state") == "expired"]    # Keep stable order for valid users    valid_sorted = sorted(        valid,        key=lambda a: int(a.get("priority", EXPIRED_PRIORITY))    )    for i, acc in enumerate(valid_sorted, start=1):        acc["priority"] = i    for acc in expired:        acc["priority"] = EXPIRED_PRIORITY